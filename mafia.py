import asyncio
import logging
import os
from aiogram import Bot, Dispatcher
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
from dotenv import load_dotenv
from random import sample, shuffle, randint
from concurrent.futures import ThreadPoolExecutor
from model_handler import ModelHandler
from utils import try_send_html
from types import SimpleNamespace

load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID"))
MAX_NEW_TOKENS = int(os.getenv("MAX_NEW_TOKENS"))
SHORT_NEW_TOKENS = int(os.getenv("SHORT_NEW_TOKENS"))

logging.basicConfig(level=logging.INFO)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
executor = ThreadPoolExecutor(max_workers=1)
model_handler = ModelHandler(MAX_NEW_TOKENS, SHORT_NEW_TOKENS)

NAMES = [
    "–ò–≤–∞–Ω", "–ü–µ—Ç—Ä", "–ê–ª–µ–∫—Å–µ–π", "–î–º–∏—Ç—Ä–∏–π", "–°–µ—Ä–≥–µ–π", "–ú–∏—Ö–∞–∏–ª",
    "–ê–Ω–¥—Ä–µ–π", "–í–ª–∞–¥–∏–º–∏—Ä", "–ê—Ä—Ç–µ–º", "–ù–∏–∫–æ–ª–∞–π", "–ï–≥–æ—Ä", "–ò–≥–æ—Ä—å",
    "–§–µ–¥–æ—Ä", "–ì–ª–µ–±", "–ú–∞–∫—Å–∏–º", "–†–æ–º–∞–Ω", "–ì—Ä–∏–≥–æ—Ä–∏–π", "–õ–µ–≤"
]

PLAYER_PROMPTS = [
    "–¢—ã –æ–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å –¥–µ—Ä–µ–≤–Ω–∏, –≤–µ–¥–∏ —Å–µ–±—è –∏—Å–∫—Ä–µ–Ω–Ω–µ –∏ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è —É–±–µ–¥–∏—Ç—å –¥—Ä—É–≥–∏—Ö, —á—Ç–æ —Ç—ã –Ω–µ –º–∞—Ñ–∏—è. –í—ã—Å–∫–∞–∂–∏ —Å–≤–æ—é —Ä–µ—á—å –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.",
    "–¢—ã –º–∞—Ñ–∏—è, —Å—Ç–∞—Ä–∞–π—Å—è —É–±–µ–¥–∏—Ç—å –≤—Å–µ—Ö, —á—Ç–æ —Ç—ã –æ–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å. –í—ã—Å–∫–∞–∂–∏ —Å–≤–æ—é —Ä–µ—á—å –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏, –Ω–µ –≤—ã–¥–∞–≤–∞—è —Å–µ–±—è –∏ –¥—Ä—É–≥–∏—Ö –º–∞—Ñ–∏–π."
]

def get_next_button():
    return ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="‚ñ∂Ô∏è –î–∞–ª–µ–µ")]], resize_keyboard=True)

def get_vote_button():
    return ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text="üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ")]], resize_keyboard=True)

def remove_keyboard():
    return ReplyKeyboardRemove()

game = {}

async def send_typing(chat_id):
    try:
        while True:
            await bot.send_chat_action(chat_id, "typing")
            await asyncio.sleep(2)
    except asyncio.CancelledError:
        pass

@dp.message(Command("start"))
async def start(message):
    game.clear()
    await try_send_html(
        message,
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É '–ú–∞—Ñ–∏—è'. –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (–æ—Ç 4 –¥–æ 12):",
        reply_markup=remove_keyboard()
    )
    game['state'] = 'wait_players'

@dp.message()
async def handler(message):
    user_text = message.text.strip()
    if game.get('state') == 'wait_players':
        try:
            n_players = int(user_text)
            if 4 <= n_players <= 12:
                game['n_players'] = n_players
                await try_send_html(message, "–°–∫–æ–ª—å–∫–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∞—Ñ–∏–π (1 –∏–ª–∏ 2)?")
                game['state'] = 'wait_mafia'
            else:
                await try_send_html(message, "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 4 –¥–æ 12")
        except:
            await try_send_html(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
        return

    if game.get('state') == 'wait_mafia':
        try:
            n_mafia = int(user_text)
            if n_mafia not in (1, 2) or n_mafia >= game['n_players']:
                await try_send_html(message, "–ú–∞—Ñ–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 –∏–ª–∏ 2, –∏ –º–µ–Ω—å—à–µ —á–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤.")
                return
            await setup_game(message, game['n_players'], n_mafia)
        except:
            await try_send_html(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ 1 –∏–ª–∏ 2.")
        return

    if user_text.lower() == "‚ñ∂Ô∏è –¥–∞–ª–µ–µ" and game.get('state') == 'game_day':
        await next_player_phase(message)
        return

    if user_text.lower() == "üó≥Ô∏è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ" and game.get('state') == 'game_day':
        await voting_phase(message)
        return

    if user_text.lower() == "‚ñ∂Ô∏è –¥–∞–ª–µ–µ" and game.get('state') == 'game_night':
        await mafia_night_phase(message)
        return

async def setup_game(message, n_players, n_mafia):
    names = sample(NAMES, n_players)
    mafia_indices = sample(range(n_players), n_mafia)
    roles = ["–º–∞—Ñ–∏—è" if i in mafia_indices else "–º–∏—Ä–Ω—ã–π" for i in range(n_players)]
    prompts = []
    for i in range(n_players):
        if i in mafia_indices:
            mafia_names = [names[j] for j in mafia_indices if j != i]
            if mafia_names:
                info = f"–¢—ã –º–∞—Ñ–∏—è. –î—Ä—É–≥–∏–µ –º–∞—Ñ–∏–∏: {', '.join(mafia_names)}."
            else:
                info = "–¢—ã –º–∞—Ñ–∏—è. –¢—ã –æ–¥–∏–Ω –≤ –∫–æ–º–∞–Ω–¥–µ –º–∞—Ñ–∏–∏."
            prompts.append(info + " " + PLAYER_PROMPTS[1])
        else:
            prompts.append("–¢—ã –º–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å. " + PLAYER_PROMPTS[0])

    game.update({
        'names': names,
        'roles': roles,
        'prompts': prompts,
        'step': 0,
        'state': 'game_day',
        'alive': [True] * n_players,
        'last_killed': None
    })

    awaiting = []
    for i, (name, role, prompt) in enumerate(zip(names, roles, prompts)):
        txt = f"–ò–≥—Ä–æ–∫ {name}: {prompt}"
        awaiting.append(txt)
    await try_send_html(
        message,
        "–†–æ–ª–∏ —Ä–æ–∑–¥–∞–Ω—ã. –ù–∞–∂–º–∏—Ç–µ '‚ñ∂Ô∏è –î–∞–ª–µ–µ', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–µ–Ω—å. –î–∞–ª–µ–µ –∫–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å —Å–≤–æ—é —Ä–µ—á—å.",
        reply_markup=get_next_button()
    )
    await try_send_html(
        SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
        "–ó–∞–ø—É—â–µ–Ω–∞ –∏–≥—Ä–∞ –≤ –º–∞—Ñ–∏—é.\n" + "\n\n".join(awaiting)
    )

async def next_player_phase(message):
    names = game['names']
    prompts = game['prompts']
    roles = game['roles']
    step = game['step']
    alive = game['alive']
    total = len(names)

    while step < total and not alive[step]:
        game['step'] += 1
        step = game['step']

    if step >= total:
        await try_send_html(
            message,
            "–í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤—ã—Å—Ç—É–ø–∏–ª–∏. –ù–∞–ø–∏—à–∏—Ç–µ 'üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ' —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é.",
            reply_markup=get_vote_button()
        )
        return

    name = names[step]
    prompt = prompts[step]
    role = roles[step]
    aspect_prompt = f"–¢—ã –∏–≥—Ä–æ–∫ {name}, —Ç–≤–æ—è —Ä–æ–ª—å: {role}. –í–æ—Ç —Ç–≤–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: {prompt}\n–°–∫–∞–∂–∏ —Å–≤–æ—é —Ä–µ—á—å –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏."
    typing_task = asyncio.create_task(send_typing(message.chat.id))
    loop = asyncio.get_event_loop()
    speech = await loop.run_in_executor(
        executor,
        model_handler.generate_short_responce,
        aspect_prompt
    )
    typing_task.cancel()

    await try_send_html(
        message,
        f"üó£ <b>{name}:</b>\n{speech}",
        reply_markup=get_next_button()
    )
    admin_report = (
        f"üí° <b>–ü—Ä–æ–º–ø—Ç, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ –º–æ–¥–µ–ª—å:</b>\n"
        f"{aspect_prompt}\n\n"
        f"üó£ <b>{name}:</b>\n"
        f"{speech}"
    )
    await try_send_html(
        SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
        admin_report
    )
    game['step'] += 1

async def voting_phase(message):
    names = game['names']
    alive = game['alive']
    surviving_indices = [i for i, a in enumerate(alive) if a]
    shuffle(surviving_indices)
    votes = {}
    n_alive = len(surviving_indices)
    for i in surviving_indices:
        candidates = [j for j in surviving_indices if j != i]
        target = candidates[randint(0, len(candidates) - 1)]
        votes.setdefault(target, []).append(i)
    results = []
    for voted, voters in votes.items():
        voter_names = ", ".join([names[i] for i in voters])
        results.append(f"–ó–∞ {names[voted]} –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: {voter_names}")
    most_voted = max(votes.items(), key=lambda x: len(x[1]))[0]
    game['alive'][most_voted] = False
    game['last_killed'] = most_voted
    game['step'] = 0
    await try_send_html(
        message,
        "<b>üó≥Ô∏è –ì–æ–ª–æ—Å–∞:</b>\n" + "\n".join(results),
        reply_markup=get_next_button()
    )
    await try_send_html(
        message,
        f"<b>{names[most_voted]} –≤—ã–±—ã–ª –∏–∑ –∏–≥—Ä—ã!</b>",
        reply_markup=get_next_button()
    )
    await try_send_html(
        SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
        "<b>üó≥Ô∏è –ì–æ–ª–æ—Å–∞:</b>\n" + "\n".join(results) + f"\n\n<b>{names[most_voted]} –≤—ã–±—ã–ª –∏–∑ –∏–≥—Ä—ã!</b>"
    )

    mafia_alive = sum([game['roles'][i] == '–º–∞—Ñ–∏—è' and game['alive'][i] for i in range(len(names))])
    city_alive = sum([game['roles'][i] == '–º–∏—Ä–Ω—ã–π' and game['alive'][i] for i in range(len(names))])
    if mafia_alive == 0:
        await try_send_html(
            message,
            "–ú–∏—Ä–Ω—ã–µ –ø–æ–±–µ–¥–∏–ª–∏! üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.",
            reply_markup=remove_keyboard()
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            "–ú–∏—Ä–Ω—ã–µ –ø–æ–±–µ–¥–∏–ª–∏! üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞."
        )
        game['state'] = 'over'
        return
    elif city_alive <= mafia_alive:
        await try_send_html(
            message,
            "–ú–∞—Ñ–∏—è –ø–æ–±–µ–¥–∏–ª–∞! üòà –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.",
            reply_markup=remove_keyboard()
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            "–ú–∞—Ñ–∏—è –ø–æ–±–µ–¥–∏–ª–∞! üòà –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞."
        )
        game['state'] = 'over'
        return
    else:
        await try_send_html(
            message,
            "üåô –ù–∞—á–∞–ª–∞—Å—å –Ω–æ—á—å. –¢–µ–ø–µ—Ä—å –º–∞—Ñ–∏—è –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –∂–µ—Ä—Ç–≤—É. –ù–∞–∂–º–∏—Ç–µ '‚ñ∂Ô∏è –î–∞–ª–µ–µ'.",
            reply_markup=get_next_button()
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            "üåô –ù–∞—á–∞–ª–∞—Å—å –Ω–æ—á—å. –¢–µ–ø–µ—Ä—å –º–∞—Ñ–∏—è –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –∂–µ—Ä—Ç–≤—É. –ù–∞–∂–º–∏—Ç–µ '‚ñ∂Ô∏è –î–∞–ª–µ–µ'."
        )
        game['state'] = 'game_night'
        game['step'] = 0

async def mafia_night_phase(message):
    names = game['names']
    roles = game['roles']
    alive = game['alive']
    mafia_indices = [i for i, role in enumerate(roles) if role == "–º–∞—Ñ–∏—è" and alive[i]]
    peaceful_indices = [i for i, role in enumerate(roles) if role == "–º–∏—Ä–Ω—ã–π" and alive[i]]
    all_alive_indices = [i for i, status in enumerate(alive) if status]

    victims_votes = []
    for mafia_id in mafia_indices:
        visible_names = [names[j] for j in all_alive_indices if j != mafia_id]
        aspect_prompt = (
            f"–¢—ã {names[mafia_id]}, –º–∞—Ñ–∏—è.\n"
            f"–ò–∑ –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: {', '.join(visible_names)}.\n"
            "–°–æ–≥–ª–∞—Å—É–π—Ç–µ—Å—å –º—ã—Å–ª–µ–Ω–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ –º–∞—Ñ–∏—è–º–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –û–î–ù–û–ì–û –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ –º–∞—Ñ–∏–∏ —Ä–µ—à–∞—é—Ç —É–±–∏—Ç—å –Ω–æ—á—å—é. "
            "–ù–∞–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –ò–ú–Ø —Ç–æ–≥–æ, –∫–æ–≥–æ –≤—ã —Ä–µ—à–∏–ª–∏ —É–±–∏—Ç—å."
        )
        typing_task = asyncio.create_task(send_typing(message.chat.id))
        loop = asyncio.get_event_loop()
        llm_answer = await loop.run_in_executor(
            executor,
            model_handler.generate_short_responce,
            aspect_prompt
        )
        typing_task.cancel()
        victim_name = None
        for n in visible_names:
            if n in llm_answer:
                victim_name = n
                break
        if not victim_name:
            victim_name = visible_names[randint(0, len(visible_names)-1)]
        victims_votes.append(victim_name)
        admin_report = (
            f"üí° <b>–ü—Ä–æ–º–ø—Ç, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ –º–æ–¥–µ–ª—å:</b>\n"
            f"{aspect_prompt}\n\n"
            f"ü¶π‚Äç‚ôÇÔ∏è <b>{names[mafia_id]} (–º–∞—Ñ–∏—è) –≤—ã–±—Ä–∞–ª:</b> {llm_answer}"
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            admin_report
        )
    final_victim = max(set(victims_votes), key = victims_votes.count)
    victim_index = names.index(final_victim)
    game['alive'][victim_index] = False
    game['last_killed'] = victim_index
    mafia_alive = sum([game['roles'][i] == '–º–∞—Ñ–∏—è' and game['alive'][i] for i in range(len(names))])
    city_alive = sum([game['roles'][i] == '–º–∏—Ä–Ω—ã–π' and game['alive'][i] for i in range(len(names))])
    await try_send_html(
        message,
        f"üåë –ù–æ—á—å—é –±—ã–ª —É–±–∏—Ç –∏–≥—Ä–æ–∫ {final_victim}!",
        reply_markup=get_next_button()
    )
    await try_send_html(
        SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
        f"üåë –ù–æ—á—å—é –±—ã–ª —É–±–∏—Ç –∏–≥—Ä–æ–∫ {final_victim}!"
    )
    if mafia_alive == 0:
        await try_send_html(
            message,
            "–ú–∏—Ä–Ω—ã–µ –ø–æ–±–µ–¥–∏–ª–∏! üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.",
            reply_markup=remove_keyboard()
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            "–ú–∏—Ä–Ω—ã–µ –ø–æ–±–µ–¥–∏–ª–∏! üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞."
        )
        game['state'] = 'over'
        return
    elif city_alive <= mafia_alive:
        await try_send_html(
            message,
            "–ú–∞—Ñ–∏—è –ø–æ–±–µ–¥–∏–ª–∞! üòà –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.",
            reply_markup=remove_keyboard()
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            "–ú–∞—Ñ–∏—è –ø–æ–±–µ–¥–∏–ª–∞! üòà –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞."
        )
        game['state'] = 'over'
        return
    else:
        game['state'] = 'game_day'
        game['step'] = 0
        await try_send_html(
            message,
            "‚òÄÔ∏è –ù–∞—Å—Ç—É–ø–∞–µ—Ç —É—Ç—Ä–æ. –ò–≥—Ä–æ–∫–∏ —Å–Ω–æ–≤–∞ –º–æ–≥—É—Ç –≤—ã—Å—Ç—É–ø–∏—Ç—å. –ù–∞–∂–º–∏—Ç–µ '‚ñ∂Ô∏è –î–∞–ª–µ–µ'.",
            reply_markup=get_next_button()
        )
        await try_send_html(
            SimpleNamespace(answer=lambda text, **kwargs: bot.send_message(ADMIN_CHAT_ID, text, **kwargs)),
            "‚òÄÔ∏è –ù–∞—Å—Ç—É–ø–∞–µ—Ç —É—Ç—Ä–æ. –ò–≥—Ä–æ–∫–∏ —Å–Ω–æ–≤–∞ –º–æ–≥—É—Ç –≤—ã—Å—Ç—É–ø–∏—Ç—å. –ù–∞–∂–º–∏—Ç–µ '‚ñ∂Ô∏è –î–∞–ª–µ–µ'."
        )

if __name__ == "__main__":
    asyncio.run(dp.start_polling(bot))
